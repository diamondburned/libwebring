function o(r){let e=t=>t.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll("'",r).replaceAll('"',"&quot;");return(t,...i)=>{let n=t[0],h=1;for(let a of i){switch(typeof a){case"string":n+=e(a);break;case"number":n+=a.toString();break;case"object":switch(Object.keys(a)[0]){case"content":n+=a.content.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");break;case"attr":n+=e(a.attr);break;case"scriptString":n+=a.scriptString.replaceAll("\\","\\\\").replaceAll("<","\\x3C").replaceAll('"','\\"');break;case"param":n+=e(encodeURIComponent(a.param));break;case"verbatim":n+=a.verbatim;break}break}n+=t[h++]}return n}}var g=o("&#39;"),d=o("&apos;");var s=class{constructor(e,t){this.src=e;this.opts=t;this.#t=t.data||null,this.#e=t.statusData||null}#t=null;#i=null;#e=null;surroundingLinks(){if(!this.available)return null;let e=this.#t.ring.indexOf(this.#i);if(e==-1)return null;let t=(e-1+this.#t.ring.length)%this.#t.ring.length,i=(e+1)%this.#t.ring.length;return{left:this.#t.ring[t],right:this.#t.ring[i]}}get data(){return this.#t}set data(e){this.#t=e,this.initLink()}get statusData(){return this.#e}set statusData(e){this.#e=e}get link(){return this.#i}get available(){return!!this.#t&&!!this.#i}async update(){this.#t=null,this.#e=null,await this.init()}includeLink(e){if(this.#e){let t=this.#e.anomalies[e.link];if(t&&(t.dead||this.opts.excludeMissingWebringSites&&t.missingWebring))return!1}return!0}async init(){if(this.#t||(await this.initData(this.src),this.initLink()),!this.#e)try{await this.initStatusData(this.opts.statusSrc||p(this.src))}catch(e){console.error("Failed to fetch status data",e)}}async initData(e){let t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch webring data: ${t.status}`);if(this.#t=await t.json(),this.#t.version!=1)throw new Error(`Unsupported webring format version: ${this.#t.version}`)}initLink(){if(this.opts.name)this.#i=this.#t.ring.find(e=>e.name===this.opts.name);else{let e=window.location.host;this.#i=this.#t.ring.find(t=>c(t.link,e))}}async initStatusData(e){let t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch status data: ${t.status}`);switch(this.#e=await t.json(),this.#e.version){case 1:{this.#t.ring=this.#t.ring.filter(i=>this.includeLink(i));break}default:throw new Error(`Unsupported status format version: ${this.#e.version}`)}}},l=class extends HTMLElement{constructor(){super();let t=this.attributes.src?.value;if(!t){console.error("Not rendering webring: missing src attribute"),this.setVisible(!1);return}this.webring=new s(t,{name:this.attributes.name?.value,statusSrc:this.attributes["status-src"]?.value,excludeMissingWebringSites:this.hasAttribute("exclude-missing-webring-sites")}),b(this)&&(this.innerHTML=g`
        <p class="ring-info">
          <a href="#" class="ring" target="_blank"></a> webring
        </p>
        <p class="ring-body">
          <a class="left" href="#" target="_blank"></a>
          <span class="middle"></span>
          <a class="right" href="#" target="_blank"></a>
        </p>
      `)}connectedCallback(){this.update()}update(){this.webring.update().then(()=>this.render())}render(){for(let i in this.dataset)delete this.dataset[i];let t=this.webring.surroundingLinks();if(!t){this.setVisible(!1);return}this.dataset.ringName=this.webring.data.name,this.dataset.linkName=this.webring.link.name,this.dataset.leftLinkName=t.left.name,this.dataset.rightLinkName=t.right.name,this.$(".left",i=>{i.href=u(t.left),i.textContent=t.left.name}),this.$(".ring",i=>{i.href=this.webring.data.root,i.textContent=this.webring.data.name||""}),this.$(".middle",i=>{i.textContent=this.webring.link.name||""}),this.$(".right",i=>{i.href=u(t.right),i.textContent=t.right.name}),this.setVisible(!0)}setVisible(t){this.setAttribute("style",t?"":"display: none;")}$(t,i){let n=this.querySelector(t);if(!n)throw new Error(`Element not found: ${t}`);i(n)}};function c(r,e){return r==e||e.endsWith(`.${r}`)}function u(r){return r.link.includes("://")?r.link:`https://${r.link}`}function b(r){return r.innerHTML.trim()==""}function p(r){let e=r.split(".");return e[e.length-1]="status."+e[e.length-1],e.join(".")}customElements.define("webring-element",l);export{s as Webring,l as WebringElement};
//# sourceMappingURL=webring.js.map
